
```table-of-contents
```

# 1.¬™ part: DNS

Per la configuraci√≥ DNS, farem servir Bind9.
Ens ho descarreguem amb:

``` shell
sudo apt install bind9
```

Anem als directoris de configuraci√≥ i copiarem els seg√ºents fitxers:

```shell
cd /etc/bind
sudo cp db.0 db.192.168.0
sudo cp db.empty db.carpi.inc
```

Editem el fitxer de configuraci√≥:

```shell
sudo nvim named.conf.local
```

I posem el seg√ºent:

```python
zone 'carpi.inc' {
        type master;
        file "/etc/bind/db.carpi.inc";
};

zone '0.168.192.in-addr.arpa'{
        type master;
        file "/etc/bind/db.192.168.0";
};
```

Aqu√≠ estem declarant que la zona del domini ser√† el fitxer `db.carpi.inc` (√©s el fitxer que hem copiat abans) i tamb√© declarem la zona inversa amb el fitxer. `db.192.168.0`

En el fitxer de configuraci√≥ `db.carpi.inc`, posem el seg√ºent:

``` python
; BIND reverse data file for empty rfc1918 zone
;
; DO NOT EDIT THIS FILE - it is used for multiple zones.
; Instead, copy it, edit named.conf, and use that copy.
;
$TTL    86400
@       IN      SOA     carpi.inc. admin.carpi.inc. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                          86400 )       ; Negative Cache TTL
;
@       IN      NS      ns.carpi.inc.
ns      IN      A       192.168.0.200
www     IN      CNAME   lilcarpi.duckdns.org.
```

Al fitxer `db.192.168.0`:

```python
;
; BIND reverse data file for "this host on this network" zone
;
$TTL    604800
@       IN      SOA     ns.carpi.inc. admin.carpi.inc. (
                              1         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
;
@       IN      NS      ns.carpi.inc.
200     IN      PTR     ns.carpi.inc
200     IN      PTR     www.lilcarpi.duckdns.org.
```

Si ets un paranoic amb la seguretat (com jo jaja) pots afegir en el `named.conf.options` restriccions com limitar les consultes (allow-query) o posar ACLs.

Fem un restart amb:
```shell
sudo systemctl restart bind9
```
---
# 2.¬™ Part: Sortida a internet amb nom.

Aquesta part ha sigut una mica complicada, ja que per sortir a internet, necessitem un nom per poder ser recognoscibles sense posar l'adre√ßa IP publica en cada moment. 

	*Problema: No tinc IP Publica Est√°tica* 

Cercant a internet, m'he trobat amb la p√†gina [Duckdns](https://duckdns.org), la qual ens dona un suport per tenir a la web un servidor que vagui verificant que la nostra IP p√∫blica sigui visible mitjan√ßant un curl. M√©s endavant veureu com.

---

# üö®**IMPORTANT: CGNAT**üö®

√âs important entendre que, encara que fem servir serveis com **DuckDNS** per associar un nom de domini a la nostra IP p√∫blica, pot ser que encara no puguem accedir des de fora si el nostre ISP fa servir **CGNAT (Carrier-Grade NAT)**
**CGNAT** fa que m√∫ltiples usuaris comparteixin una mateixa IP p√∫blica, i aix√≤ impedeix obrir ports directament cap al nostre dispositiu.

**Per saber-ne si estem a CGNAT:**
- Compara la IP p√∫blica que et dona el teu R√∫ter amb la teva IP p√∫blica reial (pots fer servir ***tracert/traceroute*** o un servei web com ***whatsmyip.com***). S√≠ s√≥n diferents, probablement est√†s baix **CGNAT**.
- **Truca al teu ISP**. La forma m√©s f√†cil √©s trucant. Aix√≠ t'ho diran directament ells i podries demanar canviar-ho a una IP p√∫blica fixa. El problema ser√† que et voldran cobrar m√©s.

**Possibles solucions:**
- Contracta una IP p√∫blica amb el teu ISP (normalment haur√†s de pagar (experi√®ncia personal xd))
- Fer servir t√∫nels (com ***Ngrok o Cloudflare Tunnel***) per exposar serveis.
---
## 2.1.¬∫- DUCKDNS

Per registrar-nos a la seva p√†gina, podem fer servir un compte de Google. Jo inicio f√†cilment amb l'api.

Una vegada estem dins, ens demanar√† el nom del nostre URL personalitzat:
Quan acceptem, tamb√© ens donar√† un token d'inici de sessi√≥. Amb aix√≤ podrem fer un script per aconseguir la nostra adre√ßa IP, a m√©s de donar-li un nom a la nostra p√†gina web de forma legal.

En aquest cas, la nostra web es dir√† ***¬®lilcarpi.duckdns.org¬®***
![[Duckdns.png]]

---
## 2.2.¬∫- Creaci√≥ del script per DUCKDNS
Necessitarem un script que ens actualitzi la nostra IP assignada al subdomini DuckDNS. Farem un script que ens verifiqui la IP cada 5 minuts.

Primer, al nostre home per exemple, farem una carpeta dedicada i un fitxer de configuraci√≥ que es digui `duck.sh

```shell
mkdir ~/duckdns ; touch ~/duckdns/duck.sh
```

Editem el fitxer que acabem de crear i posarem el seg√ºent:
``` shell
echo url="https://duckdns.org/update?domains=lilcarpi&token=CONFIDENCIAL&ip=" | curl -k -L -o ~/duckdns/duck.log -K -0
```

![[duck-sh-script.png]]
Ho desglossarem per entendre-ho millor:

1. `echo url="..."`: Aix√≤ ens genera una l√≠nia de configuraci√≥ pel `curl`, especificant l'URL que es far√† servir per actualitzar la IP en DuckDNS.
2. `curl -k -o ~/duckdns/duck.log -K -`
- `-k`: indica a `curl` que ignori els errors de certificats SSL.
- `-L`: indica a `curl`que segueixi les redireccions.
- `-o ~/duckdns/duck.log`: Guarda la sortida de la comanda a l'arxiu `duck.log` dins del directori que vam crear abans, `~/duckdns`.
- `-K -`: Indica a `curl` que llegeixi les opcions de configuraci√≥ des de l'entrada est√†ndard (en aquest cas, la sortida de la comanda `echo`).

***Funcionament:***
L'script envia la sol¬∑licitud a DuckDNS per actualitzar l'adre√ßa IP associada al subdomini `lilcarpi` (el meu). En deixar el par√†metre `ip=` vuit, DuckDNS detectar√† autom√†ticament la IP p√∫blica des de la qual es fa la sol¬∑licitud i l'assignar√† al subdomini. El resultat de l'operaci√≥ es guardar√† a l'arxiu `duck.log`, a on podr√†s verificar si l'actualitzaci√≥ ha sigut exitosa (`ok`) o si hi ha hagut qualsevol error (`ko`).

***Seguretat (nom√©s per si de cas):***
Anir√† b√© que pos√©ssim nom√©s que el nostre usuari pugui modificar el `duck.sh`, ja que cont√© un token de sessi√≥ que nom√©s haur√≠em de tenir-ne acc√©s nosaltres, perqu√® √©s una cosa confidencial (si algun graci√≥s aconsegueix el nostre token, pot clonar la nostra web D: ).

``` shell
chmod 700 ~/duckdns/duck.sh
```
(*Aix√≤ fa que nom√©s l'usuari propietari tingui acc√©s al fitxer*).


***Automatitzaci√≥***
Ara, passarem a l'automatitzaci√≥. Per mantenir-ho actualitzat autom√†ticament, podem programar aquest script perqu√® s'executi autom√†ticament utilitzant `cron`. 

`Cron` √âs un dimoni que executa tasques programades. √âs gestionat pel sistema i els fitxers de configuraci√≥ normalment estan a `/etc/crontab`.

Tamb√© tenim altres directoris especials dins de `/etc`, com:

- `/etc/cron.d/`: Per arxius de tasques programades espec√≠fiques creades per paquets o administradors
- `/etc/cron.daily/`, `/etc/cron.hourly/`, `/etc/cron.weekly/`, `/etc/cron.montly`: Directoris a on pots passar els scripts que vulguis que s'executin autom√†ticament cada dia, hora, setmana o m√©s.

A m√©s d'aix√≤, cada usuari t√© el seu propi **crontab personal** (no √©s un arxiu que edites directament). Es fa servir amb la seg√ºent comanda:

```shell
crontab -e
```

El seu contingut es guarda en llocs com `/var/spool/cron/crontabs/-usuari-` (depenent de la distro). En aquest cas, anirem amb l'√∫ltima opci√≥:

```shell
crontab -e
----"Posem aix√≤ a ultima linea"-----

*/5 * * * * bash ~/duckdns/duck.sh
```

La part `*/5 * * * *`, √©s una expressi√≥ de `cron` que indica quan executar la comanda. El format general √©s:

``` plain
MINUT HORA D√≠A_DEL_MES D√çA_DE_LA_SETMANA comanda
```

Cada camp pot tenir valors espec√≠fics, rangs o asteriscs (`*` que vol dir "tots els valors possibles").

En aquest cas seria aix√≤:

| CAMP              | VALOR | SIGNIFICAT             |
| ----------------- | ----- | ---------------------- |
| Minut             | `*/5` | Cada 5 minuts          |
| Hora              | `*`   | Cada hora              |
| D√≠a del Mes       | `*`   | Cada d√≠a               |
| Mes               | `*`   | Cada mes               |
| D√≠a de la setmana | `*`   | Cada d√≠a de la setmana |
O sigui: `Executa cada 5 minuts, sense importar l'hora, el d√≠a o el mes.`

I el que executa √©s la comanda amb **bash** que vam passar tamb√© al script que es troba a `~/duckdns/duck.sh`

Una vegada fet aix√≤, ja podrem cercar la nostra web amb nom üóøüëå.

# Apache2 i certificaci√≥ SSL amb CertBot

## Apache2

Pen√∫ltim pas, canviar la pestanya avorrida `Funciona!` del Apache per una bona p√†gina amb peus i cara.

En aquest cas, he optat per posar la meva p√†gina personal amb apartats de M12 (que √©s a on estareu llegint aix√≤ probablement jeje :) ).

Primer de tot, baixar√© la p√†gina ja feta a `/var/www`. En aquest cas, l'he posat el nom de  `HPPP (Html-Personal-Page-Project)`:

Un `tree` de l'estructura ja feta:
![[tree-page.png]]

Ara, passarem a la configuraci√≥ d'Apache.

Anirem als fitxers de configuraci√≥ i ens copiarem l'arxiu de configuraci√≥ `HTTP`:

``` shell
cd /etc/apache2/sites-available ; cp 000-default.conf carpi_inc.conf
```

Una vegada copiat, editarem el nou `carpi_inc.conf` i posarem el seg√ºent:

``` ini
<VirtualHost *:80>
        ServerName lilcarpi.duckdns.org

        ServerAdmin webmaster@localhost
        DocumentRoot /var/www/HPPP/pages/lobby

        Alias /pages /var/www/HPPP/pages

        ErrorLog ${APACHE_LOG_DIR}/error.log
        CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```

Guardem i sortim.

Per habilitar la nostra web, farem:

```shell
sudo a2ensite carpi_inc.conf ; sudo a2dissite 000-default.conf ; sudo systemctl restart apache2
```

Amb aquesta comanda, **habilitem la nostra web personal**, deshabilitem la web per defecte del ***Apache*** i reiniciem el servei `apache2.conf`.

Ara al pas 2. Donar-li un certificat SSL amb CertBot

## Certificaci√≥ SSL amb CertBot

>"A veure, primer de tot, he d'aclarir una cosa. Es pot fer un certificat manualment, no fa falta fer servir aquest m√®tode si no voleu. El problema que t√© fer-lo a m√†, √©s que el certificat no estar√† signat per una entitat v√†lida i el navegador ho detectar√† com **no segur**.

```

Una vegada aclarit aix√≤, *nem al lio*.

Instal¬∑lem CertBot

```shell
sudo apt install certbot python3-certbot-apache
```

Una vegada instal¬∑lat, l'executem amb:

``` shell
sudo certbot --apache -d lilcarpi.duckdns.org
```
(*Si tens un altre nom web, canviar-lo.*)

Ara, segueix i accepta tot el que et demani. Crec que et demanar√† el correu per registrar-te i acceptar els terminis i condicions pel certificat.

Compte, el certificat SSL **caduca cada noranta dies**. CerBot ja configura un *auto-renew* a un `cron` o `systemd timer`, per√≤ pots verificar-ho amb:

```shell
sudo certbot renew --dry-run
```

Una vegada hagi acabat, podr√†s verificar els canvis anant a `/etc/apache2/sites-enabled` i veur√†s la p√†gina amb certificat SSL:

![[ssl-certificate-confirmation.png]]
Tamb√©, ho podem verificar anant a la nostra p√†gina:
![[Certificado-CertBot.gif]]

Aqu√≠ veiem que la p√†gina ha sigut verificat per "**Let's Encrypt**". Teniu m√©s informaci√≥ al certificat si voleu mirar-ho m√©s endins.

Si heu arribat fins aqu√≠, ***Congratulations***. Ja teniu un Web Server Hoster üßâüóøüëç

# Refor√ßament

Fa falta una refor√ßament pel port SSH.
Far√© servir *fail2ban*, que √©s un programa de prevenci√≥ d'intrusions. 
